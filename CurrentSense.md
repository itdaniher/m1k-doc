The characteristics of any feedback control system, like the current force loop on the M1K, are limited by at least the properties of the sensor. Additionaly, the ability of the M1K to characterise the impedance of attached systems relies on the precise, high speed measurement of the actual output current. In the design of similar such devices, current measurement was a prime roadblock limiting the performance, with cost-effective measurement parts like the INA213, LT1999, or MAX9919F each suffering from a combination of common mode error, low speed, or nonlinearities over the common mode voltage range. This is not shocking. All of these amplifiers have a hard job - in a high side sense configuration, they monitor the voltage drop across a small precision resistor acting as a shunt. These parts must amplify microvolts of differential signal while rejecting volts of rapidly changing common mode potential. A triangle wave sweeping zero to five volts at ten kilohertz on an unloaded output represents a challenge for even the best of these amplifiers, as they work to reject harmonics many times the frequency of the fundamental, spanning the full rail-to-rail input range.

The standard topologies for amplifiers working to measure small signals in the presence of large common mode voltages do not fare substantially better when realised using discrete components or integrated solutions. 

The cannonical four-resistor, one-opamp difference amplifiers offers a seemingly attractive solution. On first inspection, this system offers perfect common mode rejection at DC, extraordinarily high input impedance, easily adjustable gain, and a wide input voltage range. Unfortunately, these properties only exist when the topology is realised with ideal resistors and a perfect opamp, which happen to be unusually rare and expensive. A mismatch as small as 0.1% between any of the resistors will result in a common mode rejection no better than 66dB, equivalent to phantom milliamps of current showing up with full scale sweeps. Additional mismatches between opamp nodes, in bias current, input impedance, and parasitics make this topology very difficult to use for our purposes.

The three opamp instrumentation amplifier, the other often encountered solution for the measurement of small signals in the presence of large common mode voltages, fares no better. In this configuration, a difference amplifier like shown above is prefaced with two buffer/gain stages, offering higher input impedance and, by encorporating most of the matched resistors on the same die as the amplifiers, alleviates many of the issues which result in poor common mode rejection through factory precision adjustment. Unfortunately, as the inputs are followed immediatley by gain stages, this topology is unable to afford the measurement of signals with a common mode voltage within a factor of the gain from the voltage supplies. This means that a three opamp instrumentation amplifier with a gain of twenty, supplied by 0v and 5v rails like the amplifier on the M1K, is unable to measure current with an output voltage further than 2.5v/20 away from the 2.5v midsupply reference, clearly inappropriate for this application.

How, then, is this design challenge addressed on the M1K? ADI offers a family of high-performance bidirectional current sense amplifiers offered for automotive engine control applications. The AD8210, offering a small signal bandwidth of 450KHz and a common mode rejection between 80 and 95dB for common mode voltages between 0v and 5v at frequencies up to 100KHz appears to be an ideal fit for the high side shunt signal conversion. Unsuprisingly, given the previously enumerated challenges, getting acceptable performance out of this part was not without its challenges.

Let us first consider the topology of the AD82xx family by examining Figure 1 in the AD8210 datasheet. To paraphrase both the theory of operation section (pg X) and conversations with ADI personell familiar with the part... a current-mode difference amplifier comprised of R1, R2, A1, Q1, Q2 acts to convert a small voltage difference across the inputs into a current difference through the emitters of Q1 and Q2, which serve as preamplifiers and buffers from the input to the output gain stage. R3 and R4 convert these current differences back into ground-referenced voltage differences, where the instrumentation amplifier A2 has well-defined operation and subtracts and multiplies these voltages, offering a midpoint referenced output voltage with a net gain of 20x.

This topology offers many of the advantages of the previously described architectures, while using a level-shifting current-mode topology to work around the inherent limitations of the above. The incorporation of all the necessary well-matched components on the same piece of silicon as the main amplifier allows for factory trimming to maintain the high common mode rejection required, and the level shifting architecture prevents the saturation of the instrumentation amplifier across a wide range of common mode voltages. "Popping the hood" on this part and inspecting the SPICE netlist model offers additional insight into the operation of this component. The "input stage" section of [the netlist](http://www.analog.com/static/imported-files/spice_models/AD8210.cir) can be represented as follows:

It was suprising to discover several facts as depicted in this representation of the device. First, a biasing diode, responsible for ensuring the currents, when operating with common mode voltages less than or equal to 5VDC, do not produce erroneous voltages further down the signal chain. Also suprising was the corresponding nature of the stated 1.5k common mode input impedance for this operating regime - the resistance described in the datasheet is not to ground, but to the high rail voltage supply. Moreover, this impedance does not apply continuously to 5v, but to input signals within approximately a diode drop (0.2v-0.7v) of the 5v rail.

The value of R1 and R2, as well as that of Rcm1 and Rcm2, were also not directly stated in the datasheet, but were ncessary factors in achieving the desired performance. The ADALM1000 was designed with a 0.5o current sense resistor, mapping the full range of \pm 200mA to a 2.5v-centered output, swinging from 0.5v to 4.5v. The topology on the M1K RevB resmebled

The root cause of the issue was not immediately apparent, but initial tests of the hardware revealed substantial common mode signal leakage, on the order of phantom milliamps. Significant head-scratching and some tremendously helpful conversations later produced the following explanation and solution.

An equally valid representation of the circuit above shows the 0.5o sense resistor in series with the negative input. See the issue yet? The 0.5o sense resistor corresponds to a roughly 0.03% mismatch between the legs of the difference amplifier input stage, resulting in the observed ~70dB of attenuation of the common mode signal. Fortunately, the solution was simple - add an extra 0.5o resistor in series with the positive input of each amplifier, bringing balance to the -force- current paths.

Additional complexity resulted from mismatch in maximum voltage input of the analog-to-digital converter and the output range of the amplifier. A one-pole low pass filter with a DC gain of 4/5 and a corner frequency slightly higher than 100KHz was constructed from a 150o resistor, 600o resistor, and 10nf capacitor. This serves to reduce the dynamic range to one matching the 4.096v reference voltage of the ADC without adding an extra voltage reference. This also afforded the added benefit of reducing the effective impedance and out of band noise seen by the ADC, and served to keep ADC sampling from back-coupling into the analog signal path.
