The ADALM1000 is a learning tool designed to make interacting with the world around you easier and more intuitive. Offering two analog channels, it allows you to source and measure waveforms in voltage or current, easily characterising arbitrary systems in terms of voltage vs current, over time, and over frequency. To offer this functionality, it uses a number of building blocks to take the fixed 5V supply and digital interface of USB and offer voltage and current operation from 0v to 5v, from -200mA to 200mA, with precision and accuracy better than 100uV, 100uA, and 10uS.

USB is a high complexity, high speed digital interface designed for PC peripherals, offering a number of defailt device types and communication schemes. While tremendously useful for the "last inches" of interface between a host PC and the M1K, the pieces of the M1K responsible for converting between analog values and digital words (analog-digital converters (ADC) and digital-analog converters (DAC)) use simpler, less robust communication schemes necessitating "glue" between a computer and the analog systems for voltage/current measurement and control. On the M1K, this glue is a microcontroller using a CPU designed by ARM (Cortex M3), with peripherals and software designed by Atmel - part number ATSAM3U2C.

The SAM3U is a great, affordable part for this USB-everything bridge position, used similarly in other products including the [4pi](https://0xfb.com/shop.html) RepRap 3d printer controller and the [osmosdr](http://sdr.osmocom.org/trac/)). The manufacturer offers a free (gratis) software framework for working with both USB and the other functionality of the part which was used extensively to create the M1K's firmware, the program loaded on each M1K at the factory.

In addition to the three serial peripheral interfaces (SPI busses) used for the M1K's two ADCs and DAC, the SAM3U also offers

 * timer-counters used for controlling 'when' the data converters sample
 * pulse-width modulation, used to set the unique LED color of each M1K on the three-channel (RGB) LED
 * two-wire interface, similar to SMBUS or I2C, used as a low-speed communication network between the SAM3U controller and other "housekeeping" components
 * digital input-output pins used for both the user-accessible programmable IO pins and to control the internal switches used in the analog frontend
 * 32 kilobytes SRAM, allowing for local data buffering and the potential for loading user-supplied software directly on to the device
 * 128 kilobytes NAND flash memory, allowing for the storage of the firmware program and the potential for data logging without use of a PC.

The SAM3U is only one of the pieces sitting between the USB connector and the analog components used for the front-end interface. Besides mapping between digital protocols, there is one more big problem to solve before we can build the analog system: power.

The USB specification (available from the USB implementers forum) is a 600+ page document describing every aspect of the ideal operation of a USB2.0 device. It requires that attached devices consume less than 500mA from the provided voltage supply, which is allowed to range from as high as 5.25v to as low as 4.40v - a wide span clearly unacceptable for a precision tool! Additionally, the power available on USB ports can vary widely in terms of both electrical noise and electrical protection. An [out-of-spec device]() attached to the shared USB bus can throw tens or even hundreds of millivolts of noise onto the voltage supply. A poorly crafted computer may not handle overcurrent conditions on a USB bus with anything more than an immediate and complete power-off, or worse, permenantly disabling a USB port. It would be unfortunate if using the M1K on an old computer degraded the accuracy of measurements and unacceptable if making mistakes during the normal operation of the device put the attached computer at risk of damage or lost data. To address these issues and provide protected, low noise voltage supplies to the analog frontend, a sophisticated supply chain as designed to ensure that regardless of input, the full 0-5v range is available at the output, and regardless of shorting or overvolting the device, the host PC is not exposed to unacceptable risk.

The M1K power chain consists of a grand total of three linear voltage regulators, two switching voltage regulators, a "hot-swap" controller, and a precision reference. The crude 5v supply from the USB bus is first used to supply a 3.3v to the SAM3U controller, which is generated using an ADP7118 fixed voltage linear regulator. This regulator, and the microcontroller it supplies, are always-on, as the SAM3U is responsible for requesting the full 500mA available from the host. After device enumeration, the analog frontend is enabled using the ADM1177 hot-swap controller, which allows for the well-behaved turn-on of the remainder of the power section, as well as overcurrent (short-circuit) protection. The ADM1177 monitors the drop across a 0.1 ohm current-sense shunt resistor and controls the gate of a nFET power transistor. When the enable pin of the hot-swap controller is driven high, it pumps current into the gate of the switching transistor at a rate determined by an external capacitor, until the gate of the transistor is substantially above the input voltage, and the transistor acts as a series resistor with a fixed (small) resistance.

There are two switch-mode regulators which use energy storage in inductors to accomplish what is difficult (not quite impossible) to do with standard CMOS (complimentary metal-oxide transistor, resistor, capacitor) circuits - increase voltage and provide a negative voltage. The ADP1614 boost-converter controller is used to generate a 6.5 volt power supply rail by fluxing up an inductor and causing a sudden change in current to generate a voltage above that which is used to store energy in the magnetic flux of the core of the inductor. This boosted power supply is relatively noisy, with frequency components from the switching frequency (fixed at 1.3MHz) to several times this, resulting from the inconsistent voltage and current output waveforms. A pi-topology filter and a large output capacitor serve to attenuate the high frequency noise components and average the output voltage. The result is a 6.5v supply with relatively little output noise with little current draw. As the current draw increases, the output noise does as well, and some broadband noise remains due to the inherently noisy topolyg of the boost converter. To reduce the noise further, and supply a clean "high" voltage rail to the analog frontend, which must be able to supply 5v at up to 200mA, the ADM7171 adjustable voltage regulator is used to convert the approximately 500mV of headroom voltage, along with the ~50mV of electrical noise, into heat. The resulting 6v output from the adjustable linear regulator is comparitively free of noise, across the entire spectrum. This 6.0v supply is used for many of the analog components in the frontend, including the AD8018 power output stage and the ADG1611 analog output switch. This 6v0 supply provides more than the required headroom to allow the AD8018 output amplifiers to supply 5v at the output, even after the additional voltage drops associated with the analog frontend. The ADP2442 is the second switching regulator, [used in an inverting buck-boost configuration](http://www.analog.com/static/imported-files/application_notes/AN-1269.pdf) to supply a voltage below the minimum supply (0v, ground) of USB. To provide output operation all the way down to ground (0v), a negative one volt rail (-1v0) is generated in a fashion similar to the 6v5 rail generation described above - energy is stored in an inductor, and a sudden change in current creates a potential less than that of ground. A similar pi filter topology is used to attenuate the out of band signals created by this process, resulting in an adequately clean -1v0 supply, which powers the AD8018 and ADG1611 output stage, as well as the ADA4661 servo amplifier.

Having generated the voltages required for the output stage, additional clean supplies are required for operating other aspects of the analog systems. The data converters (DAC and ADC) require that the analog output/input voltages are less than or equal to the supply voltage, and both require a supply voltage less than 5.5v. As such, a 5.0v rail is generated using the ADM7118 linear regulator from the 6.0v rail described above, offering a low noise, high precision voltage supply for the remainder of the mixed-signal components, afforementioned AD5663R digital-analog converter, the two AD7682 analog-digital converters, the AD8210 current-sense differential amplifier, and the ADG719 analog mode-switch. 
